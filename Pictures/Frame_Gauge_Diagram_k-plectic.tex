%+------------------------------------------------------------------------+
%| Diagram: Kiddo Diagram - k-plectic case
%| Author: Antonio miti
%+------------------------------------------------------------------------+


\documentclass[beamer,handout]{standalone}
\usepackage{tikz-cd}
\usepackage{mathtools}
\usepackage{amsfonts}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{cd, fit}

	%Credit: https://tex.stackexchange.com/questions/99119/beamer-problematic-use-of-visible-and-only-in-combination-with-tikz-to-draw-a
  \tikzset{
    invisible/.style={opacity=0},
    visible on/.style={alt=#1{}{invisible}},
    alt/.code args={<#1>#2#3}{%
      \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
    },
  }
\definecolor{grey}{rgb}{0.30, 0.30, 0.30}


\begin{document}
	\begin{tikzcd}[
		column sep= small,row sep=small,
		/tikz/execute at end picture={
    		\node (large) [rectangle,dashed, draw, fit=(A1) (A2) (A3),label=below:{\scriptsize$L_\infty$-algebras cat.}] {};
  		}]		
		|[visible on=<1-3>]| \color{grey}{(M,\omega)} 
		\ar[drr,grey,visible on=<1-3>,rightsquigarrow,"\text{observables}"]
		\ar[rrrr,grey,visible on=<1-3>,rightsquigarrow,"\text{twisted standard Vinogradov algebroid}"]
		\ar[dddd,grey,visible on=<1-3>,rightsquigarrow,sloped,"\text{gauge transf.}"']
		&[-1.5em] & &[2em] 
		&[-3em] |[visible on=<1-3>]| \color{grey}{(E^n,\rho,\langle\cdot,\cdot\rangle,[\cdot,\cdot]_\omega)}
		\ar[dl,grey,visible on=<1-3>,rightsquigarrow]
		\ar[dddd,grey,visible on=<2-3>,sloped,"\cong","\text{B-transf.}"']
%
	\\
%
		& \phantom{\big(}
		& |[visible on=<1->,alias=A1]| L_{\infty}(M,\omega)
		\ar[r,visible on=<1->,line width=0.8pt,color=blue!60!black,"\Psi"]
		\ar[ddr,visible on=<5->,phantom,blue,"\circlearrowright"]
		& |[visible on=<1->]| L_{\infty}\big(E^n,\omega\big)
		\ar[dd,sloped,"\cong", visible on=<3->]
		&
%		 
	\\
%
		&|[visible on=<4->,alias=A2]|\mathfrak{g} \ar[ur,visible on=<4->]\ar[dr,visible on=<4->]& & & 
%
	\\
%
		& &|[visible on=<1->]| L_{\infty}(M,\tilde{\omega})
		\ar[r,visible on=<1->,line width=0.8pt,color=blue!60!black,"\Psi"]& 
		|[visible on=<1->,alias=A3]| L_{\infty}\big(E^n,{\tilde{\omega}}\big)
		&
%		
	\\
%	
		|[visible on=<1-3>]| \color{grey}{(M,\tilde{\omega})}
		\ar[rrrr,grey,visible on=<1-3>,rightsquigarrow,"\text{ }"]
		\ar[urr,grey,visible on=<1-3>,rightsquigarrow,"\text{ }"]
		& \phantom{\big(} & & 
		& |[visible on=<1-3>]| \color{grey}{(E^n,[\cdot,\cdot]_{\tilde{\omega}})}
		\ar[ul,grey,visible on=<1-3>,rightsquigarrow]
 	\end{tikzcd}	







\end{document}


		\only<6->{(M,\tilde{\omega}) \ar[rrrr,rightsquigarrow,"\text{}"]
		\ar[urr,rightsquigarrow,"\text{observables}"] }
		& \phantom{\big(} & & 
		& \only<6->{(TM\oplus\bigwedge^{k-1}T^\ast M,\rho,\langle\cdot,\cdot\rangle,[\cdot,\cdot]_{\tilde{\omega}}) \ar[ul,rightsquigarrow] }
 	\end{tikzcd}	